@model IEnumerable<GovFinance.Models.ExpenseCategory>
@{
    ViewData["Title"] = "المصاريف الثابتة";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">@ViewData["Title"]</h1>
    <a class="btn btn-primary"
       asp-action="Create"
       asp-route-returnUrl="@Url.Action("Create", "MyExpenses")">إضافة مصروف أساسي</a>
</div>

<table class="table" id="expensesTable">
    <thead>
        <tr>
			<th>ID</th>
            <th>الاسم</th>
            <th>المبلغ الافتراضي</th>
            <th style="width:60px;"></th>
            <th style="width:60px;"></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var x in Model)
        {
            <tr>
                <td class="text-muted small" data-order="@x.Id">@x.Id</td>

                <td>@x.Name</td>
                <td>@x.DefaultAmount.ToString("N2")</td>
                
                    <td class="">
                        <form asp-action="Delete" method="post" onsubmit="return confirm('حذف؟');">
                            <input type="hidden" name="id" value="@x.Id" />
                            <button class="btn btn-sm btn-outline-danger">حذف</button>
                        </form>
                    </td>
                <td class="">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                data-edit-cat
                                data-id="@x.Id">
                            تعديل
                        </button>
                    </td>
               
            </tr>
        }
    </tbody>
</table>
<div class="modal fade" id="catEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content content-card">
            <div class="modal-header">
                <h5 class="modal-title">تعديل مصروف ثابت</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div id="catEditModalBody" class="modal-body"><div class="text-center py-3">...</div></div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        (function(){
          const modalEl = document.getElementById('catEditModal');
          const bodyEl  = document.getElementById('catEditModalBody');
          const modal   = modalEl ? new bootstrap.Modal(modalEl) : null;

          document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-edit-cat]');
            if (!btn || !modal) return;

            const id = btn.getAttribute('data-id');
            bodyEl.innerHTML = '<div class="text-center py-3">جارٍ التحميل…</div>';

            const res = await fetch(`/ExpenseCategories/Edit/${id}?asPartial=true`, {
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              credentials: 'include'
            });
            bodyEl.innerHTML = await res.text();

            // إعادة تفعيل unobtrusive validation داخل المودال إن وجدت
            if (window.jQuery && window.jQuery.validator && window.jQuery.validator.unobtrusive) {
              window.jQuery.validator.unobtrusive.parse(bodyEl);
            }

            // إعادة ربط submit داخل المودال (نفس أسلوب _CreateForm)
            const form = bodyEl.querySelector('form[data-modal-form]');
            if (form) {
              form.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const fd  = new FormData(form);
                const res = await fetch(form.action + (form.action.includes('?') ? '' : '') , {
                  method: 'POST',
                  body: fd,
                  headers: { 'X-Requested-With': 'XMLHttpRequest' },
                  credentials: 'include'
                });
                const ct = res.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                  const data = await res.json();
                  if (data.ok) {
                    // هنا ممكن تحدّث الصف في الجدول حسب احتياجك…
                    modal.hide();
                    location.reload(); // أبسط حل
                    return;
                  }
                }
                bodyEl.innerHTML = await res.text(); // أخطاء تحقق
              });
            }

            modal.show();
          });
           const params = new URLSearchParams(location.search);
            const len = parseInt(params.get('len') || '10', 10);
            const pageLen = (isFinite(len) && len > 0) ? len : 10;

            new DataTable('#expensesTable', {
                responsive: true,
                deferRender: true,
                pageLength: pageLen,
                lengthMenu: [[10, 20, 50, 100, -1], [10, 20, 50, 100, 'الكل']],
                order: [[1, 'desc']],
                language: {
                    search: 'بحث:',
                    lengthMenu: 'عرض _MENU_',
                    info: 'إظهار _START_–_END_ من _TOTAL_',
                    infoEmpty: 'لا توجد سجلات',
                    zeroRecords: 'لا نتائج',
                    paginate: { first: 'الأول', last: 'الأخير', next: 'التالي', previous: 'السابق' }
                }
            });
        })();
    </script>
}
